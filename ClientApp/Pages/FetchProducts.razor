@page "/products"
@using System.Text.Json
@inject HttpClient Http

<h3>Product List</h3>

@if (errorMessage != null)
{
    @* Visualizzazione dell'errore *@
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}

@if (products == null && errorMessage == null)
{
    @* Stato di caricamento con Spinner *@
    <div class="d-flex align-items-center">
        <div class="spinner-border text-primary me-2" role="status"></div>
        <span>Loading products...</span>
    </div>
}
else if (products != null)
{
    @* Visualizzazione della lista prodotti *@
    <ul class="list-group">
        @foreach (var product in products)
        {
            <li class="list-group-item">
                <strong>@product.Name</strong> - $@product.Price 
                @if (product.Category != null)
                {
                    <span class="badge bg-info text-dark ms-2">@product.Category.Name</span>
                }
                <div class="text-muted" style="font-size: 0.85rem;">Stock: @product.Stock</div>
            </li>
        }
    </ul>
}

@code {
    private Product[]? products;
    private string? errorMessage; 

    // [Ottimizzazione]: Cache statica per evitare chiamate API ridondanti
    private static Product[]? _cachedProducts; 

    protected override async Task OnInitializedAsync()
    {
        // Se i dati sono già in cache, non chiamare il server
        if (_cachedProducts != null) 
        {
            products = _cachedProducts;
            return;
        }

        try
        {
            // 1. Richiesta al server (usa il BaseAddress configurato in Program.cs)
            var response = await Http.GetAsync("api/productlist");
            
            // 2. Debugging: controlla se la rotta o il server rispondono OK
            response.EnsureSuccessStatusCode();

            // 3. Legge il JSON come stringa
            var json = await response.Content.ReadAsStringAsync();

            // 4. Deserializzazione con gestione dei nomi (case-insensitive)
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            products = JsonSerializer.Deserialize<Product[]>(json, options);

            // [Ottimizzazione]: Salva nella cache solo se l'operazione è riuscita
            if (products != null)
            {
                _cachedProducts = products;
            }
        }
        catch (JsonException jex)
        {
            // Debugging specifico per JSON malformato
            errorMessage = "Errore dati: Il formato ricevuto dal server non è valido.";
            Console.WriteLine($"Dettaglio tecnico JSON: {jex.Message}");
        }
        catch (Exception ex)
        {
            // Debugging generico (Server spento, 404, CORS)
            errorMessage = $"Errore di sistema: {ex.Message}";
            Console.WriteLine($"Errore di debug: {ex.Message}");
        }
    }

    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public double Price { get; set; }
        public int Stock { get; set; }
        public CategoryInfo? Category { get; set; }
    }

    public class CategoryInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }
}