@page "/products"

@using System.Text.Json
@inject HttpClient Http

<h3>Product List</h3>

@if (errorMessage != null)
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}
else if (products == null)
{
    <div class="d-flex align-items-center">
        <div class="spinner-border text-primary me-2" role="status"></div>
        <span>Loading products...</span>
    </div>
}
else
{
    <ul>
        @foreach (var product in products)
        {
            <li>
                <strong>@product.Name</strong> - $@product.Price - Stock: @product.Stock
                @if (product.Category != null)
                {
                    <em>(Category: @product.Category.Name)</em>
                }
            </li>
        }
    </ul>
}



@code {
    private Product[]? products;
    private string? errorMessage; 

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Facciamo la richiesta 
            var response = await Http.GetAsync("http://localhost:5013/api/productlist");
            
            // 2. Controlliamo se il server ha risposto OK (200)
            response.EnsureSuccessStatusCode();

            // 3. Leggiamo il contenuto come semplice testo
            var json = await response.Content.ReadAsStringAsync();

            // 4. Proviamo a trasformare il testo in oggetti C#
            // Se il JSON è sbagliato, qui salta l'eccezione
            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            products = JsonSerializer.Deserialize<Product[]>(json, options);
        }
        catch (JsonException jex)
        {
            errorMessage = "Errore dati: Il formato ricevuto dal server non è valido.";
            Console.WriteLine($"Dettaglio tecnico JSON: {jex.Message}");
        }
        catch (Exception ex)
        {
            // Se il JSON è sbagliato o il server è spento, mostriamo l'errore
            errorMessage = $"Errore di debug: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    public class Product
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public double Price { get; set; }
        public int Stock { get; set; }
        public CategoryInfo? Category { get; set; }
    }

    public class CategoryInfo
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }
}